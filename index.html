<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js" integrity="sha512-d9xgZrVZpmmQlfonhQUvTR7lMPtO7NkZMkA0ABN3PHCbKA5nqylQ/yWlFAyY6hYgdF1Qh6nYiuADWwKB4C2WSw==" crossorigin="anonymous"></script>
  </head>
  <body>
    <h1>
      Alberta COVID-19 Variant of Concern Dashboard
    </h1>
    <h2 id="last-updated">
      Last Updated February 16
    </h2>
    <canvas id="line-chart"></canvas>
    <canvas id="bar-chart"></canvas>
    <canvas id="bar-chart2"></canvas>
    <script>
      var lineChartCtx = document.getElementById('line-chart');
      var barChartCtx = document.getElementById('bar-chart');
      var barChart2Ctx = document.getElementById('bar-chart2');
      var lastUpdatedField = document.getElementById("last-updated")

      const dataEndpoint = "https://d3eu7xn6iz7q5z.cloudfront.net"

      vocReq = fetch(dataEndpoint + "/voc.json");
      dailyReq = fetch(dataEndpoint + "/daily_cases.json");
      Promise.all([vocReq, dailyReq]).then(function(values) {
        vocResponse = values[0]
        dailyResponse = values[1]

        if (vocResponse.status != 200) {
          console.log("Looks like there was a problem. Status code: " + vocResponse.status);
          return;
        }
        if (dailyResponse.status !== 200) {
          console.log('Looks like there was a problem. Status Code: ' + dailyResponse.status);
          return;
        }

        Promise.all([vocResponse.json(), dailyResponse.json()]).then(function(jsonValues) {
          vocJson = jsonValues[0]
          dailyJson = jsonValues[1]

          dates = Object.keys(vocJson["B117"]["Cumulative"])
          lastDate = dates[dates.length - 1]
          lastUpdatedField.innerText = "Last Updated " + lastDate

          b117_cumulative_cases = Object.values(vocJson["B117"]["Cumulative"])
          b1351_cumulative_cases = Object.values(vocJson["B1351"]["Cumulative"])
          p1_cumulative_cases = Object.values(vocJson["P1"]["Cumulative"])

          b117_daily_cases = Object.values(vocJson["B117"]["Daily"])
          b1351_daily_cases = Object.values(vocJson["B1351"]["Daily"])
          p1_daily_cases = Object.values(vocJson["P1"]["Daily"])

          weeks = Object.keys(vocJson["All VOC"]["Weekly"])
          weeklyVOC = Object.values(vocJson["All VOC"]["Weekly"])
          weeklyAll = Object.values(dailyJson["Weekly"])

          var myLineChart = new Chart(lineChartCtx, {
            type: "line",
            data: {
              labels: dates,
              datasets: [
                {
                  label: "B117",
                  data: b117_cumulative_cases,
                  backgroundColor: "#FF0000",
                  borderColor: "#FF0000",
                  fill: false
                },
                {
                  label: "B1351",
                  data: b1351_cumulative_cases,
                  backgroundColor: "#0000FF",
                  borderColor: "#0000FF",
                  fill: false
                },
                {
                  label: "P1",
                  data: p1_cumulative_cases,
                  backgroundColor: "#008000",
                  borderColor: "#008000",
                  fill: false
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              title: {
                display: true,
                text: "AB Cumulative VOC By Reporting Date"
              }
            }
          })

          var myBarChart = new Chart(barChartCtx, {
            type: "bar",
            data: {
              labels: dates,
              datasets: [
                {
                  label: "B117",
                  data: b117_daily_cases,
                  backgroundColor: "#FF0000",
                  borderColor: "#FF0000",
                },
                {
                  label: "B1351",
                  data: b1351_daily_cases,
                  backgroundColor: "#0000FF",
                  borderColor: "#0000FF",
                },
                {
                  label: "P1",
                  data: p1_daily_cases,
                  backgroundColor: "#008000",
                  borderColor: "#008000",
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              scales: {
                xAxes: [{
                  stacked: true
                }],
                yAxes: [{
                  stacked: true
                }]
              },
              title: {
                display: true,
                text: "AB Daily VOC Cases By Reporting Date"
              }
            }
          })

          var myBarChart2 = new Chart(barChart2Ctx, {
            type: "bar",
            data: {
              labels: weeks,
              datasets: [
                {
                  label: "Non-VOC",
                  data: weeklyAll,
                  backgroundColor: "#808080",
                  borderColor: "#808080",
                },
                {
                  label: "VOC",
                  data: weeklyVOC,
                  backgroundColor: "#FF0000",
                  borderColor: "#FF0000",
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              tooltips: {
                callbacks: {
                  label: function(toolTipItem, data) {
                    index = toolTipItem.index
                    vocData = data.datasets.find(dataset => dataset.label === "VOC")
                    allData = data.datasets.find(dataset => dataset.label === "Non-VOC")

                    vocCases = vocData.data[index]
                    allCases = allData.data[index]
                    percentVOC = ((vocCases/allCases)*100).toFixed(2)
                    return percentVOC + "% VOC\n" + "(" + vocCases + "/" + allCases + ")";
                  },
                  labelColor: function(tooltipItem, chart) {
                    return {
                      borderColor: "#FF0000",
                      backgroundColor: "#FF0000"
                    }
                  }
                }
              },
              scales: {
                xAxes: [{
                  stacked: true
                }],
                yAxes: [{
                  stacked: true
                }]
              },
              title: {
                display: true,
                text: "AB Proportion VOC By Week Starting Jan 25th"
              }
            }
          })
        });
      });
    </script>
  </body>
</html>
